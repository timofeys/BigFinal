
Процедура ОбработкаПроведения(Отказ, Режим)
	
	Движения.ДвижениеМатериалов.Записывать = Истина;
	Движения.ДвижениеМатериалов.БлокироватьДляИзменения = Истина;
		
	Движения.ДвижениеМатериалов.Очистить();
	
	Для Каждого ТекСтрокаМатериалы Из Материалы Цикл
		Движение = Движения.ДвижениеМатериалов.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
		Движение.Период = Дата;
		Если ЗначениеЗаполнено(МОЛ) тогда 
			Движение.МОЛ = МОЛ;
			ПеременнаяДляТекстаЗапроса = "МОЛ = &МОЛ";
		Иначе
			Движение.Склад = Склад;
			ПеременнаяДляТекстаЗапроса = "Склад = &Склад";
		КонецЕсли;
		Движение.Материал = ТекСтрокаМатериалы.Материал;
		Движение.Количество = ТекСтрокаМатериалы.Количество;
	КонецЦикла;
	
	Движения.Записать();
	
	ЗапросОтрицательныхОстатков = Новый Запрос;
	ЗапросОтрицательныхОстатков.Текст = "ВЫБРАТЬ
	 |	ДвижениеМатериаловОстатки.Склад,
	 |	ДвижениеМатериаловОстатки.Материал,
	 |	ДвижениеМатериаловОстатки.Материал.Представление,
	 |	ДвижениеМатериаловОстатки.КоличествоОстаток
	 |ИЗ
	 |	РегистрНакопления.ДвижениеМатериалов.Остатки(
	 |			,"
	 + ПеременнаяДляТекстаЗапроса +
	 "	И Материал В (&Материал)) КАК ДвижениеМатериаловОстатки
	 |ГДЕ
	 |	ДвижениеМатериаловОстатки.КоличествоОстаток < 0";
	 Если ЗначениеЗаполнено(Склад) тогда
		 ЗапросОтрицательныхОстатков.УстановитьПараметр("Склад",Склад);
	 Иначе
		 ЗапросОтрицательныхОстатков.УстановитьПараметр("МОЛ",МОЛ);
	 КонецЕсли;
	 ЗапросОтрицательныхОстатков.УстановитьПараметр("Материал",Материалы.ВыгрузитьКолонку("Материал"));
	 РезЗапроса = ЗапросОтрицательныхОстатков.Выполнить();
	 Если НЕ РезЗапроса.Пустой() тогда
	     Отказ = Истина;
	 Выборка = РезЗапроса.Выбрать();
	 Сообщение = Новый СообщениеПользователю;
	 Пока Выборка.Следующий() Цикл 
		Сообщение.Текст = "Остатка не хватает" + Выборка.МатериалПредставление + " в количестве - " + Выборка.КоличествоОстаток;
		Сообщение.Сообщить();
	КонецЦикла;
КонецЕсли;

КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	ЗаполнитьВидДокумента();
КонецПроцедуры

Процедура ЗаполнитьВидДокумента()
	Если ЗначениеЗаполнено(МОЛ) тогда
		ВидДокумента = Перечисления.ВидДокументаДвижения.Возврат_ИзКладовой;
	ИначеЕсли ЗначениеЗаполнено(Склад) тогда
		ВидДокумента = Перечисления.ВидДокументаДвижения.Возврат_ИзКладовой;
	КонецЕсли;
КонецПроцедуры	
